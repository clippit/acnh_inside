# BCSV

BCSV 是一种二进制压缩的 CSV 文件，共有 167 个。BCSV 中存储了大量游戏内的数据和参数，可以认为是其核心数据库。

## 二进制格式

BCSV 由三部分组成：

| 名称 | 长度 |
|----|----|
| 头部 | 28 [1Ch] |
| 字段定义 | 8 * 字段个数 |
| 数据条目 | 每条数据长度 * 总条数 |

### 头部

| 偏移量 | 格式 | 说明 |
|------|----|----|
| 0x00 | uint32 | 数据条目个数 |
| 0x04 | uint32 | 每条数据长度 |
| 0x08 | uint16 | 字段个数 |
| 0x0a | byte | 未知 |
| 0x0b | byte | 未知 |
| 0x0c | [4]byte | Magic 固定值 "VSCB" |
| 0x10 | [2]byte | 未知 |
| 0x12 | [10]byte | 0 Padding |

### 字段定义

每个字段定义均为 8 个字节，按顺序给出。每个字段定义由两部分组成。

| 相对偏移量 | 格式 | 说明 |
|----------|----|----|
| 0x00 | [4]byte | 字段 ID |
| 0x04 | uint32 | 字段开始位置基于条目数据的相对偏移量 |

字段 ID 是原始字段名称的 CRC32 hash，因此占 4 字节。原始的字段名称格式为 `fidleName type`，`fieldName` 是一般字符串名称，`type` 表示字段数据类型，例如 `ItemID u16`。目前已知的有以下几种：

* `u8` `u16` `u32`：不同长度的无符号整数
* `s8` `s16` `s32`：不同长度的符号整数
* `f32`：单精度浮点数
* `stringXX`：长度为 `XX` 字节的 UTF-8 字符串

原始字段名称会在编译阶段被替换成最终的 CRC32 值，因此从 CRC32 值反向推断原始字段名比较困难。然而，游戏二进制中存在一些原始字段名的字符串数据，Github 上 [CylindricalEarth](https://github.com/Treeki/CylindricalEarth/issues/4) 对一些原始字段名进行了挖掘。

根据第二项偏移量，结合头部中的每条数据长度，我们可以计算出每个字段的长度。

### 数据条目

所有数据条目依次存储于字段定义之后。

| 相对偏移量 | 格式 | 说明 |
|----------|----|----|
| 0x00 | uint32 | 当前位置基于文件整体的偏移量 |
| 0x04 | 可变 | 各个字段的具体数据 |

每个数据条目中均按字段定义中的长度和顺序依次保存。

## 关于枚举类型的字段

有很多字段的取值是枚举（enum）类，即固定从某几个值中选择。目前尚不明确枚举类型在字段 ID 中使用什么名称表示 `type`。枚举类的值可以从二进制中提取，它们都是以英文和日文成对出现的。在 BCSV 中，存储的是值的 CRC32 hash（英文或日文的 CRC 均有可能），因此枚举类的字段长度一定是 4 字节。

例如，在 `AITag.bcsv` 中，第一个字段就是枚举类型，CRC32 的字段 ID 为 `70 CF EA A8`，以小端序读取，可以记为 uint32 形式 `2833960816`。它有四种取值：

| 英文取值 | 日文取值 | 英文取值 CRC32 |
|--------|--------|--------------|
| Season | 季節 | `0xF7485E9F` |
| MinorSeries | 裏シリーズ | `0x314A4625` |
| Purpose | 目的 | `0x773A8A77` | 
| None | なし | `0xDFA2AFF1` |

该文件的第一条数据的第一个字段的值为 `9F 5E 48 F7`，即实际对应到「Season | 季節 」值。

## 参考资料

* https://wiki.oatmealdome.me/BCSV
